// ==UserScript==
// @name         TEMUHOOK
// @namespace    SAN
// @version      1.7
// @description  TEMUHOOK 提交
// @author       XIAOSAN
// @match        *://seller.kuajingmaihuo.com/*
// @homepageURL  https://www.baidu.com
// @updateURL    https://raw.githubusercontent.com/crazyUFO/TEMUHOOK/refs/heads/main/dist/main.min.js
// @downloadURL  https://raw.githubusercontent.com/crazyUFO/TEMUHOOK/refs/heads/main/dist/main.min.js
// @require      https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.global.min.js
// @require      data:application/javascript,unsafeWindow.Vue%3DVue%2Cthis.Vue%3DVue%3B
// @require      https://cdn.jsdelivr.net/npm/element-plus@2.9.5/dist/index.full.min.js
// @resource     ELEMENT_CSS https://cdn.jsdelivr.net/npm/element-plus@2.9.5/dist/index.min.css
// @grant        unsafeWindow
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// ==/UserScript==
!function(){"use strict";const t=GM_getResourceText("ELEMENT_CSS");GM_addStyle(t),GM_addStyle('\n        #vueApp{\n            position: fixed;\n            top: 50%;\n            right: 30px;\n            z-index: 99999;\n        }\n        #vueApp .fix-tabs{\n            display: flex;\n            flex-direction: column-reverse;\n        }\n        #vueApp .logBox{\n            margin-bottom: 20px;\n            max-height: 300px;\n            overflow: auto;\n        }\n        #vueApp .process-progress{\n            display: flex;\n            flex-wrap: wrap;\n            gap: 10px;\n            margin-top: 10px;\n            justify-content: space-between;\n            align-items: center;\n        }\n        .is-blockPopUps [data-testid="beast-core-modal-mask"],\n        .is-blockPopUps [data-testid="beast-core-modal"]{\n            display: none !important;\n        }\n        .el-overlay.is-message-box {\n          z-index: 999999 !important; /* 例如 3000 */\n        }\n    ');let e=document.createElement("div");e.innerHTML='\n        <div id="vueApp">\n            <el-button type="info" @click="openPanl">TEMUHOOK</el-button>\n\n            <el-drawer v-model="settingDrawer" title="设置面板" :with-header="false" >\n\n                <el-tabs type="border-card" class="fix-tabs" v-model="currentTab">\n\x3c!--                     <el-tab-pane label="全局">\n                        <el-form :model="configSetting" label-width="auto">\n                            <el-form-item label="隐藏弹窗">\n                                <el-switch v-model="configSetting.blockPopUps" :disabled="fetchState" />\n                            </el-form-item>\n                            <el-form-item label="页面大小">\n                                <el-input v-model="configSetting.pageSize" :disabled="fetchState" />\n                            </el-form-item>\n                            <el-form-item label="起始页码">\n                                <el-input v-model="configSetting.pageNum" :disabled="fetchState" />\n                            </el-form-item>\n                            <el-form-item label="自动翻页">\n                                <el-switch v-model="configSetting.autoPage" :disabled="fetchState" />\n                            </el-form-item>\n                            <el-form-item label="等待时间">\n                                <el-input v-model="configSetting.waitSeconds" :disabled="fetchState" />\n                            </el-form-item>\n                        </el-form>\n                    </el-tab-pane> --\x3e\n                    <el-tab-pane label="上新生命周期" name="SMZQ">\n                        <el-form :model="configSetting" label-width="auto">\n                            <el-table :data="configSetting.abandonPriceRule" style="width: 100%">\n                                <el-table-column label="价格(分)">\n                                    <template #default="scope">\n                                        <el-input-number v-model="scope.row.price" :min="0" :precision="0" :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="最高价格(分)">\n                                    <template #default="scope">\n                                        <el-input-number v-model="scope.row.maxPrice" :min="0" :precision="0" :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="" width="100">\n                                    <template #default="scope">\n                                        <el-button size="small" type="danger" @click="SMZQ_abandonPriceRuleDelete(scope.$index, scope.row)" :disabled="fetchState">\n                                        Delete\n                                        </el-button>\n                                    </template>\n                                </el-table-column>\n                            </el-table>\n                            <div style="margin-top: 30px;">\n                                <el-button type="info" @click="SMZQ_abandonPriceRuleAdd" :disabled="configSetting.abandonPriceRule.length > 0">添加金额规则</el-button>\n                            </div>\n                        </el-form>\n                    </el-tab-pane>\n                    <el-tab-pane label="活动申报" name="HDSB">\n                        <el-form :model="configSetting" label-width="auto">\n                            <el-table :data="configSetting.activityPriceRule" style="width: 100%">\n                                <el-table-column label="价格(分)">\n                                    <template #default="scope">\n                                        <el-input-number v-model="scope.row.price" :min="0" :precision="0" :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="最高价格(分)">\n                                    <template #default="scope">\n                                        <el-input-number v-model="scope.row.maxPirce" :min="0" :precision="0" :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="" width="100">\n                                    <template #default="scope">\n                                        <el-button size="small" type="danger" @click="HDSB_activityPirceDelete(scope.$index, scope.row)" :disabled="fetchState">\n                                        Delete\n                                        </el-button>\n                                    </template>\n                                </el-table-column>\n                            </el-table>\n                            <div style="margin-top: 30px;">\n                                <el-button type="info" @click="HDSB_activityPirceAdd" :disabled="configSetting.activityPriceRule.length > 0">添加金额规则</el-button>\n                            </div>\n                        <el-divider>过滤字符</el-divider>\n                            <el-table :data="configSetting.activityFilerStrRule" style="width: 100%">\n                                <el-table-column label="SKU属性集">\n                                    <template #default="scope">\n                                        <el-input v-model="scope.row.str"  :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="" width="100">\n                                    <template #default="scope">\n                                        <el-button size="small" type="danger" @click="HDSB_activityFilerStrDel(scope.$index, scope.row)" :disabled="fetchState">\n                                        Delete\n                                        </el-button>\n                                    </template>\n                                </el-table-column>\n                            </el-table>\n                            <div style="margin-top: 30px;">\n                                <el-button type="info" @click="HDSB_activityFilerStrAdd">添加字符匹配过滤</el-button>\n                            </div>\n                        <el-divider>活动库存</el-divider>\n                            <el-table :data="configSetting.activityTargetActivityStock" style="width: 100%">\n                                <el-table-column label="库存数量">\n                                    <template #default="scope">\n                                        <el-input v-model="scope.row.num"  :disabled="fetchState" controls-position="right" />\n                                    </template>\n                                </el-table-column>\n                                <el-table-column label="" width="100">\n                                    <template #default="scope">\n                                        <el-button size="small" type="danger" @click="HDSB_activityTargetActivityStockDel(scope.$index, scope.row)" :disabled="fetchState">\n                                        Delete\n                                        </el-button>\n                                    </template>\n                                </el-table-column>\n                            </el-table>\n                            <div style="margin-top: 30px;">\n                                <el-button type="info" @click="HDSB_activityTargetActivityStockAdd" :disabled="configSetting.activityTargetActivityStock.length > 0">添加数量</el-button>\n                            </div>\n\x3c!--                           <el-divider>选择活动</el-divider>\n                            <el-select v-model="selectedValue" placeholder="请选择">\n                              <el-option\n                                v-for="item in options"\n                                :key="item.value"\n                                :label="item.label"\n                                :value="item.value">\n                              </el-option>\n                            </el-select> --\x3e\n                        </el-form>\n                    </el-tab-pane>\n                </el-tabs>\n                <div style="margin-top: 30px;" v-if="malInfoList.length">\n                    <el-radio-group v-model="configSetting.mallId">\n                        <el-radio v-for="item in malInfoList" :key="item.mallId" :value="item.mallId" :disabled="fetchState">{{item.mallName}}</el-radio>\n                    </el-radio-group>\n                </div>\n\x3c!--                 <div style="margin-top: 30px;">\n                    <el-button type="info" @click="dialogLogVisible = true">日志</el-button>\n                <div> --\x3e\n\n\n                <div style="margin-top: 30px;" v-if="getUserInfoState && configSetting.mallId">\n                  <el-button v-if="currentTab == \'SMZQ\'" :loading="fetchState" type="primary" @click="handleClick(\'上新生命周期\')">上新生命周期</el-button>\n\n\x3c!--                       <el-button type="info" @click="handleClick(\'批量签署JIT规则\')">批量签署JIT规则</el-button> --\x3e\n\n                    <el-button v-if="currentTab == \'HDSB\'" :loading="fetchState" type="primary" @click="handleClick(\'批量活动申报\')">批量活动申报</el-button>\n                </div>\n\n            </el-drawer>\n\n            <el-dialog v-model="dialogLogVisible" :title="\'日志: \' + clickState" destroy-on-close>\n                <template v-if="clickState == \'上新生命周期\'">\n                    <div class="logBox" v-if="logList.length">\n                        <ul>\n                            <li v-for="item in logList">\n                                {{item.text}}\n                            </li>\n                        </ul>\n                    </div>\n                    <template v-if="logInfo.totals > 0">\n                        <div><el-progress :percentage="Number((logInfo.index / logInfo.totals * 100).toFixed(2))" /></div>\n                        <div class="process-progress"><span>任务进度: {{logInfo.text}}</span><span>{{logInfo.index}}/{{logInfo.totals}}</span></div>\n                    </template>\n                </template>\n                <template v-if="clickState == \'批量签署JIT规则\'">\n                    <div class="logBox" v-if="logList.length">\n                        <ul>\n                            <li v-for="item in logList">\n                                {{item.text}}\n                            </li>\n                        </ul>\n                    </div>\n                </template>\n                <template v-if="clickState == \'批量活动申报\'">\n                    <div class="logBox" v-if="logList.length">\n                        <ul>\n                            <li v-for="item in logList">\n                                {{item.text}}\n                            </li>\n                        </ul>\n                    </div>\n                </template>\n            </el-dialog>\n        </div>\n    ',document.body.append(e);const i={data:()=>({settingDrawer:!1,currentTab:"SMZQ",dialogLogVisible:!1,selectActivity:!1,selectedValue:"",options:[{value:"1",label:"选项1"},{value:"2",label:"选项2"},{value:"3",label:"选项3"}],configSetting:Object.assign({Cookie:"",blockPopUps:!1,pageSize:100,pageNum:1,autoPage:!0,waitSeconds:3,abandonPriceRule:[],activityPriceRule:[],activityFilerStrRule:[],activityTargetActivityStock:[],token:null},GM_getValue("configSetting"),{Cookie:document.cookie}),getUserInfoState:!1,clickState:"",fetchState:!1,malInfoList:[],activityList:[],currentActivity:25022164983552,logList:[],logInfo:{index:0,totals:0,text:""}}),mounted(){this.$nextTick((()=>{this.getUserInfo(),this.HDSB_getActivityList();const t=unsafeWindow.document.body;this.configSetting.blockPopUps&&t.classList.add("is-blockPopUps"),this.configSetting}))},methods:{openPanl:async function(){await this.checkToken()&&(this.settingDrawer=!0)},login(){this.$prompt("输入令牌","提示",{confirmButtonText:"确定",cancelButtonText:"取消",customClass:"login-message-box",inputPattern:/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,inputErrorMessage:"输入令牌格式不正确"}).then((({value:t})=>{GM_xmlhttpRequest({url:"http://182.254.136.122:8765/login",method:"POST",headers:{"Content-Type":"application/json"},data:JSON.stringify({username:t}),onload:e=>{200==e.status?(this.configSetting.token=t,this.$message({type:"success",message:"你的令牌是: "+t}),this.settingDrawer=!0):(this.$message({type:"error",message:"没有此令牌"}),setTimeout((()=>{this.login()}),1e3))},onerror:t=>{console.error("Error:",t)}})})).catch((()=>{this.$message({type:"error",message:"取消输入"})}))},checkToken:async function(){return new Promise(((t,e)=>{if(!this.configSetting.token)return this.login(),void t(!1);GM_xmlhttpRequest({url:"http://182.254.136.122:8765/protected",method:"GET",headers:{"X-Username":this.configSetting.token},onload:e=>{200===e.status?t(!0):(this.configSetting.token=null,this.login(),this.$message({type:"error",message:"失效的令牌"}),t(!1))},onerror:e=>{console.error("Error:",e),t(!1)}})}))},HDSB_getMatch:function(t){const e=this.configSetting,i=new URLSearchParams(window.location.search);let n=i.get("type");const o={activityThematicId:1*i.get("thematicId"),activityType:1*n,addSite:!0,rowCount:50};return t&&(o.searchScrollContext=t),fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/gambit/marketing/enroll/scroll/match",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(o)}).then((t=>t.json()))},HDSB_submit:async function(t){const e=this.configSetting,i=new URLSearchParams(window.location.search);let n=i.get("type");const o={activityThematicId:i.get("thematicId"),activityType:n,productList:t};return fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/gambit/marketing/enroll/submit",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(o)}).then((t=>t.json()))},HDSB_getActivityList:function(){const t=this.configSetting;fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/gambit/marketing/enroll/activity/list",{method:"POST",headers:{"Content-Type":"application/json",Cookie:t.Cookie,mallid:t.mallId},body:JSON.stringify({needCanEnrollCnt:!0,needSessionItem:!0})}).then((t=>t.json())).then((t=>{if(t.success){let e=[];t.result.activityList.forEach((t=>{e=e.concat(t.thematicList)})),this.activityList=e}else console.warn(`获取活动列表失败: ${t.errorMsg}`)})).catch((t=>{console.error("获取活动列表失败: ",t)}))},waitSeconds:function(t){return new Promise((e=>setTimeout(e,1e3*t)))},getUserInfo:function(){const t=this.configSetting;fetch("https://seller.kuajingmaihuo.com/bg/quiet/api/mms/userInfo",{method:"POST",headers:{"Content-Type":"application/json",Cookie:t.Cookie},body:JSON.stringify({})}).then((t=>t.json())).then((t=>{t.success?(this.malInfoList=t.result.companyList[0].malInfoList,this.getUserInfoState=!0):console.warn(`获取用户信息失败: ${t.errorMsg}`)})).catch((t=>{console.error("获取用户信息失败: ",t)}))},SMZQ_abandonPriceRuleAdd:function(){this.configSetting.abandonPriceRule.push({price:0,maxPrice:0})},SMZQ_abandonPriceRuleDelete:function(t,e){this.configSetting.abandonPriceRule.splice(t,1)},SMZQ_AbandonPriceRule:function(t){const e=this.configSetting.abandonPriceRule[0].price,i=this.configSetting.abandonPriceRule[0].maxPrice;return console.log(e,i),t<e?3:t>i?2:1},SMZQ_AbandonPriceSet:function(t){this.configSetting.abandonPriceRule[0].price;const e=this.configSetting.abandonPriceRule[0].maxPrice;return t>e?e:t},SMZQ_searchForChainSupplier:function(t,e){const i=this.configSetting,n={pageSize:e=void 0===e?i.pageSize:e,pageNum:t,secondarySelectStatusList:[7],supplierTodoTypeList:[1]};return fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/xmen/select/searchForSemiSupplier",{method:"POST",headers:{"Content-Type":"application/json",Cookie:i.Cookie,mallid:i.mallId},body:JSON.stringify(n)}).then((t=>t.json()))},SMZQ_rejectRemark:function(t){const e=this.configSetting,i={orderIds:t};return fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/magnus/price/bargain-no-bom/batch/info/query",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(i)}).then((t=>t.json()))},SMZQ_reviewNoBom:function(t){const e=this.configSetting,i={priceOrderId:t};return fetch("https://seller.kuajingmaihuo.com/gmp/bg/magneto/api/price-review-order/no-bom/review",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(i)}).then((t=>t.json()))},SMZQ_combineData:function(t){},SMZQ_bargainNoBom:function(t){const e=this.configSetting;return fetch("https://seller.kuajingmaihuo.com/marvel-mms/cn/api/kiana/magnus/price/bargain-no-bom/batch",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(t)}).then((t=>t.json()))},HDSB_match_procution_data:function(t){const e=this.configSetting,i=e.activityPriceRule[0].price,n=e.activityPriceRule[0].maxPirce,o=e.activityFilerStrRule,l=e.activityTargetActivityStock;console.log(l);const s=this;s.fetchState=!0,s.logList=[];let a=t,c=[];if(o.length){console.log(o),s.logList.push({text:"排除掉所有SKU属性集包含的..."});let t=[],e=0;for(let i=0;i<a.length;i++){let n=a[i],o=!1;for(let t=0;t<n.skcList.length;t++){let e=n.skcList[t];for(let t=0;t<e.skuList.length;t++){let i=e.skuList[t];for(let t in i)if(this.HDSB_activityFilterSKU(i[t])){s.logList.push({text:`排除：sku属性集${i[t]}中包含设置的字符`}),o=!0;break}if(o)break}if(o)break}o?e++:t.push(n)}s.logList.push({text:`统计：共${a.length} 条数据,通过SKU属性集排除了${e}条数据`}),a=t}return a.forEach((t=>{let e={productId:t.productId,activityStock:1*(l.length>0?l[0].num:t.targetActivityStock),skcList:[],sessionIds:t.suggestEnrollSessionIdList};t.skcList.forEach((o=>{let l={skcId:o.skcId,skuList:[]};o.sitePriceList?(l.siteActivityPriceList=(o.sitePriceList?o.sitePriceList:[]).filter((t=>t.suggestActivityPrice>=i)).map((e=>{let i=e.suggestActivityPrice>n?n:e.suggestActivityPrice;return s.logList.push({text:`${t.productId}---价格 ${e.suggestActivityPrice}=>${i}`}),{activityPrice:i,siteId:e.siteId}})),l.skuList=o.skuList.map((t=>({skuId:t.skuId}))),l.siteActivityPriceList.length&&e.skcList.push(l)):(o.skuList.forEach((e=>{let o={skuId:e.skuId,siteActivityPriceList:e.sitePriceList.filter((t=>t.suggestActivityPrice>=i)).map((e=>{let i=e.suggestActivityPrice>n?n:e.suggestActivityPrice;return s.logList.push({text:`${t.productId}---价格 ${e.suggestActivityPrice}=>${i}`}),{activityPrice:i,siteId:e.siteId}}))};o.siteActivityPriceList.length&&l.skuList.push(o)})),l.skuList.length&&e.skcList.push(l))})),e.skcList.length&&c.push(e)})),c},HDSB_execute:async function(){const t=this.configSetting,e=this.waitSeconds,i=this;i.fetchState=!0,i.logList=[];let n=!0,o=null;do{let l=await this.HDSB_getMatch(o);if(l.success){let t=l.result.matchList;n=l.result.hasMore,o=n?l.result.searchScrollContext:null,i.logList.push({text:`服务器返回数据成功, 共${t.length}条数据`});let e=this.HDSB_match_procution_data(t);if(e.length){(await this.HDSB_submit(e)).success?i.logList.push({text:`活动申报成功,该页总归申报${e.length}个`}):(i.logList.push({text:"活动申报失败"}),console.warn(`活动申报失败: ${data.errorMsg}`))}else i.logList.push({text:"该页没有符合条件的数据"})}else i.logList.push({text:"获取商品信息失败"}),console.warn(`获取商品信息失败: ${data.errorMsg}`);i.logList.push({text:`等待${t.waitSeconds}秒请求....`}),await e(t.waitSeconds)}while(n);i.fetchState=!1,i.logList.push({text:"全部处理完成"})},SMZQ_execute:async function(){const t=this.configSetting,e=this.waitSeconds,i=this.SMZQ_searchForChainSupplier,n=this.SMZQ_rejectRemark,o=this.SMZQ_AbandonPriceRule,l=this.SMZQ_AbandonPriceSet,s=(this.SMZQ_reviewNoBom,this.SMZQ_bargainNoBom),a=this;a.fetchState=!0,a.logList=[],a.logInfo={index:0,totals:3,text:"正在拉取商品数据"};let c=0,r=t.pageNum;t.autoPage&&await i(1,1).then((e=>{console.log("getDataList(1,1): ",e),e.success?c=Math.ceil(e.result.total/t.pageSize):(a.logList.push({text:"获取商品信息失败"}),console.warn(`获取商品信息失败: ${e.errorMsg}`))})).catch((t=>{console.error("获取商品信息失败: ",t)}));let u=[],g=[],d=[];do{a.logList.push({text:`等待${t.waitSeconds}秒请求: 发送请求第${r}页`}),await e(t.waitSeconds),u.push(i(r)),r++,r>c&&a.logList.push({text:"请求商品列表结束,等待服务器返回数据"})}while(r<=c);Promise.all(u).then((async i=>{let o=[];i.forEach((t=>{t.success&&o.push(...t.result.dataList)})),a.logList.push({text:`服务器返回数据成功, 共${o.length}条数据`});let l=[];for(let t=0;t<o.length;t++){const e=o[t];for(let t=0;t<e.skcList.length;t++){const i=e.skcList[t];a.logList.push({text:`正在处理SKC: ${i.skcId}`});for(let t=0;t<i.supplierPriceReviewInfoList.length;t++){const e=i.supplierPriceReviewInfoList[t];0!=e.status?l.push(e.priceOrderId):a.logList.push({text:"跳过: 价格申报中"})}}}let s=this.sliceArrayInChunks(l,700);for(let[i,o]of s.entries())a.logList.push({text:`等待${t.waitSeconds}秒请求第${i+1}片: 价格推荐信息=>700条一片`}),await e(t.waitSeconds),g.push(n(o));return a.logInfo={index:1,totals:3,text:"正在处理上新审核价格"},Promise.all(g)})).then((async i=>{a.logList.push({text:"请求商品列表结束,等待服务器返回数据"});let n=[];i.forEach((t=>{console.log(t),t.success&&n.push(...t.result.priceReviewItemList)})),a.logList.push({text:`服务器返回数据成功, 共${n.length}条数据`}),a.logList.push({text:"等待: 组合提交数据"});let c=n.map((t=>{let e=o(t.suggestSupplyPrice);return 3==e?{priceOrderId:t.id,supplierResult:e,items:t.skuInfoList.map((t=>({productSkuId:t.productSkuId})))}:{priceOrderId:t.id,supplierResult:e,items:t.skuInfoList.map((t=>({productSkuId:t.productSkuId,price:l(t.suggestSupplyPrice)})))}}));a.logList.push({text:`数据组合完毕: 共${c.length}条数据`});let r=this.sliceArrayInChunks(c,200);for(let[i,n]of r.entries())a.logList.push({text:`等待${t.waitSeconds}秒请求第${i+1}片: 数据提交=>200条一片`}),await e(t.waitSeconds),d.push(s({itemRequests:n}));return a.logInfo={index:2,totals:3,text:"正在处理最后数据提交"},Promise.all(d)})).then((async t=>{t.forEach(((t,e)=>{t.success?a.logList.push({text:`返回=>第${e+1}片: 成功`}):a.logList.push({text:`返回=>第${e+1}片: 失败`})})),a.logInfo={index:3,totals:3,text:"任务全部完成"}})).then((()=>{a.logList.push({text:"所有任务已完成"}),a.fetchState=!1})).catch((t=>{console.error("服务器返回数据失败: ",t)}))},SPLB_pageQuery:function(t,e){const i=this.configSetting,n={pageSize:e=void 0===e?i.pageSize:e,page:t,skcJitStatus:3,skcSiteStatus:0};return fetch("https://seller.kuajingmaihuo.com/bg-visage-mms/product/skc/pageQuery",{method:"POST",headers:{"Content-Type":"application/json",Cookie:i.Cookie,mallid:i.mallId},body:JSON.stringify(n)}).then((t=>t.json()))},SPLB_signJIT:function(t){const e=this.configSetting,i={skcList:t};return fetch("https://seller.kuajingmaihuo.com/bg-visage-mms/product/agreement/batch/sign",{method:"POST",headers:{"Content-Type":"application/json",Cookie:e.Cookie,mallid:e.mallId},body:JSON.stringify(i)}).then((t=>t.json()))},SPLB_execute:async function(){const t=this.configSetting,e=this.waitSeconds,i=this.SPLB_pageQuery,n=this.SPLB_signJIT,o=this;o.fetchState=!0,o.logList=[];let l=0,s=t.pageNum;t.autoPage&&await i(1,1).then((e=>{console.log("pageQuery(1,1): ",e),e.success?l=Math.ceil(e.result.total/t.pageSize):(o.logList.push({text:"获取商品信息失败"}),console.warn(`获取商品信息失败: ${e.errorMsg}`))})).catch((t=>{console.error("获取商品信息失败: ",t)}));let a=[];do{o.logList.push({text:`等待${t.waitSeconds}秒请求: 发送请求第${s}页`}),await e(t.waitSeconds),a.push(i(s)),s++,s>l&&o.logList.push({text:"请求商品列表结束,等待服务器返回数据"})}while(s<=l);Promise.all(a).then((async i=>{let l=[];i.forEach((t=>{t.success&&l.push(...t.result.pageItems)})),o.logList.push({text:`服务器返回数据成功, 共${l.length}条数据`}),console.log(l);let s=[];for(let t=0;t<l.length;t++){const e=l[t];s.push({productId:e.productId,productSkcId:e.productSkcId})}let a=[];for(let t=0;t<s.length;t+=20)a.push(s.slice(t,t+20));if(a.length)for(let i=0;i<a.length;i++){const l=a[i];o.logList.push({text:`等待${t.waitSeconds}秒请求: 第${i+1}次签署,签署${l.length}个`}),await e(t.waitSeconds),await n(l).then((t=>{if(t.success){if(o.logList.push({text:`签署成功: ${t.result.successNum}`}),o.logList.push({text:`签署失败: ${t.result.failedNum}`}),t.result.failedDetailList.length)for(let e=0;e<t.result.failedDetailList.length;e++){const i=t.result.failedDetailList[e];o.logList.push({text:`Skc: ${i.productSkcId}, ${i.errorMsg}`})}}else console.warn(`签署失败: ${t.errorMsg}`)})).catch((t=>{console.error("签署失败: ",t)}))}else o.logList.push({text:"需要签署为空"});o.fetchState=!1})).catch((t=>{console.error("服务器返回数据失败: ",t)}))},HDSB_activityPirceAdd:function(){this.configSetting.activityPriceRule.push({price:0,maxPirce:0})},HDSB_activityTargetActivityStockAdd:function(){this.configSetting.activityTargetActivityStock.push({num:""})},HDSB_activityFilerStrAdd:function(){this.configSetting.activityFilerStrRule.push({str:""})},HDSB_activityTargetActivityStockDel:function(t){this.configSetting.activityTargetActivityStock.splice(t,1)},HDSB_activityFilerStrDel:function(t){this.configSetting.activityFilerStrRule.splice(t,1)},HDSB_activityPirceDelete:function(t,e){this.configSetting.activityPriceRule.splice(t,1)},HDSB_activityFilterSKU:function(t){return this.configSetting.activityFilerStrRule.some((e=>new RegExp(e.str,"i").test(t)))},handleClick:async function(t){await this.checkToken()?("上新生命周期"==t&&this.SMZQ_execute(),"批量签署JIT规则"==t&&this.SPLB_execute(),"批量活动申报"==t&&this.HDSB_execute(),this.clickState=t,this.dialogLogVisible=!0):this.settingDrawer=!1},sliceArrayInChunks:function(t,e){const i=[];let n=0;for(;n<t.length;)i.push(t.slice(n,n+e)),n+=e;return i}},watch:{configSetting:{handler(t,e){this.$nextTick((()=>{unsafeWindow.document.body.classList.toggle("is-blockPopUps",t.blockPopUps),GM_setValue("configSetting",t)}))},deep:!0}}},n=Vue.createApp(i);n.use(ElementPlus),n.mount("#vueApp")}();